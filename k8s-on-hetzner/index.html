<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>K8s on Hetzner Cloud | mateimicu</title><meta property="og:title" content="K8s on Hetzner Cloud - mateimicu"><meta property="og:description" content="I was looking at having a long-running k8s cluster for testing and pet projects, Hetzner Cloud looks like a good initiative."><meta property="og:url" content="http://mateimicu.com/k8s-on-hetzner/"><meta property="og:site_name" content="mateimicu"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/bfd5fa0a1d43b3b22492a07a578dca68?s=256"><meta property="article:section" content><meta property="article:published_time" content="2020-07-12T17:42:29+03:00"><meta property="article:modified_time" content="2020-07-12T17:42:29+03:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link href=http://mateimicu.com/index.xml rel=alternate type=application/rss+xml title=mateimicu><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://mateimicu.com/k8s-on-hetzner/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=http://mateimicu.com/><h1 id=nav-heading class="title is-4">mateimicu</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/mateimicu target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:hire@mateimicu.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/matei-marius-micu-0246a211a target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-right><a class=nav-item href=/certs/><h2 class="title is-5">Certifications</h2></a><a class=nav-item href=/pdf/matei_marius_micu_cv.pdf><h2 class="title is-5">CV</h2></a><a class=nav-item href=/workshops_and_slides/><h2 class="title is-5">Workshops & Slides</h2></a></div></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"></div><h2 class="subtitle is-6">July 12, 2020</h2><h1 class=title>K8s on Hetzner Cloud</h1><div class=content><p>I was looking at having a long-running k8s cluster for testing and pet projects, <a href=https://www.hetzner.com/cloud>Hetzner Cloud</a> looks like a good initiative.</p><h3 id=goal>Goal</h3><p>Have a running k8s cluster that fits the following criteria:</p><ul><li>Secure - the cluster will be exposed to the internet</li><li>Scalable - I&rsquo;m not sure what I will run on it, probably a lot of side projects and data mining projects, so I would like to scale it from time to time. At the same time scalability (elasticity) helps ensure the cluster is not fragile</li><li>Replicable - I want to spin a new cluster, destroy this one and recreate it at will. Replicability is partially related to scalability/elasticity but also about bootstrapping the cluster</li></ul><p>Also, a few restrictions (side quests) needed for this:</p><ul><li>learn more about security and k8s internals</li><li>don&rsquo;t spend a lot of money</li><li>going for a managed solutions is cheating (for now)</li></ul><h3 id=why-hetzner-cloudhetzner-cloud>Why <a href=https://www.hetzner.com/cloud>Hetzner Cloud</a></h3><p>I already have experience with <a href=eks>EKS</a> and <a href=do-k8s>K8s on DigitalOcean</a>, but they can get a bit expensive (especially if you start using other services).</p><p>There is a good post <a href=https://devonblog.com/containers/affordable-kubernetes-cluster/>Affordable Kubernetes Cluster by Remko Seelig</a> about using <a href=https://cloud.google.com/kubernetes-engine>GKE</a> with <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/preemptible-vms>preemptible nodes</a>, but the cluster does not have a lot of computing power.</p><p>I already looked at <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way>Kubernetes The Hard Way</a> and remembered that <a href=https://www.hetzner.com/cloud>Hetzner Cloud</a> offers pretty cheap compute instances (starts at 2,89 €).
Working with <a href=https://www.hetzner.com/cloud>Hetzner Cloud</a> means that I have to run control plane myself, this may cut in my processing power but has the advantage that I should get a more in-depth look at how it works.</p><table><thead><tr><th>Cloud Provider</th><th>Control Plane cost</th><th>worker nodes (8vCPU 16GB ram)</th><th>worker nodes count</th><th>Min Cost</th><th>Max Cost</th></tr></thead><tbody><tr><td>Google (gke)</td><td>0 (for single-zone or multi-zonal) $0.10 per hour (± 73$ per month) for regional cluster</td><td>31.86$* -> 105$ ~ 9 * g1-small * preemptible price</td><td>9</td><td>32$</td><td>105$</td></tr><tr><td>AWS (EKS)</td><td>$0.10 per hour (± 73$ per month)</td><td>28$* -> 146$ ~ 4 * a1.large in Ohio * spot insance price</td><td>4</td><td>91$</td><td>219$</td></tr><tr><td>Azure (AKS)</td><td>0</td><td>$26* -> $265.72 ~ 4 * A2 v2 in East US2 * for maximum spot instance discount</td><td>4</td><td>26$</td><td>265$</td></tr><tr><td>Linode</td><td>0</td><td>$80 ~ 4 * (2vCPU 4GB ram)</td><td>4</td><td>80$</td><td>80$</td></tr><tr><td>Digital Ocean</td><td>0</td><td>$80 ~ 4 * (2vCPU 4GB ram)</td><td>4</td><td>80$</td><td>80$</td></tr><tr><td>Hetzner Cloud</td><td>5.7€ (assuming CX21 have enough resources)</td><td>± 22 € (4 CX21)</td><td>4</td><td>27.7€ (around 32$)</td><td>27.7€ (around 32$)</td></tr></tbody></table><p>There are a few caveats with each solution:</p><ul><li>preemptible/spot instances can be shut down; we can run part of the instances as normal ones and have smart auto-scaling to provision more if needed</li><li>spot instance costs can vary for AWS and Azure (preemptible instances have a fixed price on Google)</li><li>with cloud providers (Google, AWS, Azure, DigitalOcean, Linode) other costs can occur (you can avoid them if you really want):<ul><li>extra storage costs (PV&rsquo;s for example)</li><li>data transfer/networking costs</li><li>backup costs</li><li>logging costs (for example shipping logs to CloudWatch)</li><li>load balancer costs</li></ul></li><li><a href=https://cloud.google.com/kubernetes-engine>GKE</a> with g1-small may not be worth it as the instance is pretty underpowered</li><li>Running the control plane can be tricky (this is why most of the cloud providers offer managed control plane)</li></ul><p>One big advantage of running the control plane and doing everything from scratch is the learning process (one of the side quests for this pet project).
<a href=https://www.hetzner.com/cloud>Hetzner Cloud</a> has a simple offering, I hope to get support (at least beta) for multiple things:</p><ul><li><a href=https://github.com/kubernetes/autoscaler/issues/2054>cluster auto scaler</a></li><li><a href=https://github.com/kubernetes-sigs/cluster-api>cluster api</a> (looks like somebody is starting a business around this <a href=https://www.upwork.com/jobs/Make-Kubernetes-cluster-production-ready-Hetzner-cloud-using-the-Cluster-API_~01c7e42d8122ac97ad>upwork job</a> and <a href=https://github.com/cluster-api-provider-hcloud/cluster-api-provider-hcloud/>github cluster api for hcloud</a>)</li></ul><h3 id=existing-resources-and-approaches>Existing resources and approaches</h3><p>Looking online there is already some work done in this direction</p><ul><li><a href=https://github.com/cluster-api-provider-hcloud/cluster-api-provider-hcloud/>github cluster api for hcloud</a> looks like the exact thing I want</li><li><a href=https://github.com/hobby-kube/guide>hoby-kube</a> seems to have a complete guide</li><li>There is also some documentation from <a href=https://www.hetzner.com/cloud>Hetzner Cloud</a>:<ul><li><a href=https://community.hetzner.com/tutorials/install-kubernetes-cluster>Install a Kubernetes cluster on cloud servers</a></li><li><a href=https://community.hetzner.com/tutorials/create-microk8s-cluster>Create a Microk8s Cluster</a></li></ul></li><li><a href=https://www.tmjohnson.co.uk/posts/k8s/>Create a complete cheapo Kubernetes cluster</a></li><li><a href=https://medium.com/@jmrobles/how-to-create-a-kubernetes-cluster-with-rancher-on-hetzner-3b2f7f0c037a>How to create a Kubernetes cluster with Rancher on Hetzner</a></li><li><a href=https://github.com/xetys/hetzner-kube>hetzner-kube</a></li><li><a href=https://metawave.ch/posts/kubernetes-hetzner-setup/>Kubernetes on Hetzner Cloud: Setup a Kubernetes Cluster</a></li></ul><p>There are also multiple installers for k8s; we can even consider <a href=https://k3s.io/>k3s</a> or <a href=%5Bhttps://microk8s.io/%5D>microk8s</a></p><h3 id=next-steps>Next Steps</h3><p>I&rsquo;ll probably look more at <a href=https://github.com/kubernetes-sigs/cluster-api>cluster api</a> and try to figure out how it works</p><div class=related></div></div></div></section><section class=section><div class="container has-text-centered"><p></p></div></section></body></html>