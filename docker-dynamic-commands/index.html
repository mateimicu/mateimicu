<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Docker Dynamic Commands | mateimicu</title><meta property="og:title" content="Docker Dynamic Commands - mateimicu"><meta property="og:description" content="When learning docker an interesting question you may have is: What happens with commands that install software when rebuilding an image."><meta property="og:url" content="http://mateimicu.com/docker-dynamic-commands/"><meta property="og:site_name" content="mateimicu"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/dd1a4254a9857691eef6ceeed38f6801?s=256"><meta property="article:section" content><meta property="article:published_time" content="2017-12-04T19:51:58+02:00"><meta property="article:modified_time" content="2017-12-04T19:51:58+02:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link href=http://mateimicu.com/index.xml rel=alternate type=application/rss+xml title=mateimicu><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://mateimicu.com/docker-dynamic-commands/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=http://mateimicu.com/><h1 id=nav-heading class="title is-4">mateimicu</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/mateimicu target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:contact@mateimicu.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/matei-marius-micu-0246a211a target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-right><a class=nav-item href=/slides><h2 class="title is-5">Slides</h2></a></div></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"></div><h2 class="subtitle is-6">December 4, 2017</h2><h1 class=title>Docker Dynamic Commands</h1><div class=content><p>When learning docker an interesting question you may have is: <strong>What happens with commands that install software when rebuilding an image</strong>.</p><p>Let&rsquo;s give a scenario:</p><p>You create a simple docker file like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>FROM python:2.7-slim

<span style=color:#75715e># Update the system </span>
RUN apt-get update -y <span style=color:#f92672>&amp;&amp;</span> apt-get upgrade -y

<span style=color:#75715e># add some source files</span>
ADD . /app

<span style=color:#75715e># expose a port</span>
EXPOSE <span style=color:#ae81ff>80</span>

<span style=color:#75715e># Run app.py when the container launches</span>
CMD <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span><span style=color:#f92672>]</span>
</code></pre></div><p>this is not a complete <code>Dockerfile</code>, just the snippets we are interested in.
If we try to build this an image based on this file, we get something like this:</p><pre><code>Step 1/5 : FROM python:2.7-slim
...
Step 2/5 : RUN apt-get update -y &amp;&amp; apt-get upgrade -y
...
Step 3/5 : ADD . /app
...
Step 4/5 : EXPOSE 80
...
Step 5/5 : CMD [&quot;python&quot;, &quot;app.py&quot;]
...
Successfully built 3609163bdce5
</code></pre><p>(the output is truncated to save space).
The important step is <code>2</code> where we update the system. We can see that this will download and install new versions for the libraries that we have on the system.</p><p>This can pose a problem because we may rely on a specific version of the library. In other words, next time we build the image (imagine we updated the codebase and need to create a new image
to deploy) the <code>apt-get update -y && apt-get upgrade -y</code> run and ruin the image (our application not handling the new libraries).</p><h3 id=unionfs-to-the-rescue>UnionFS to the rescue</h3><p>One thing to keep in mind is the way images are built/stored/transferred using a Union file system that works with layers. If I a layer is already found it will not be &ldquo;compiled&rdquo; again, this means that if we add a new file to our directory <code>echo "new dummy file" >> dummy</code> and our current directory will look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~ $ ls
Dockerfile   dummy
</code></pre></div><p>When running a new build:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~ $ docker build .
Sending build context to Docker daemon  3.072kB
Step 1/5 : FROM python:2.7-slim
 ---&gt; b0259cf63993
Step 2/5 : RUN apt-get update -y <span style=color:#f92672>&amp;&amp;</span> apt-get upgrade -y
 ---&gt; Using cache
 ---&gt; 00414512ae60
Step 3/5 : ADD . /app
 ---&gt; 7c8266369b33
Step 4/5 : EXPOSE <span style=color:#ae81ff>80</span>
 ---&gt; Running in 6bc4c5a16d2f
Removing intermediate container 6bc4c5a16d2f
 ---&gt; ae8b02e34ced
Step 5/5 : CMD <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span><span style=color:#f92672>]</span>
 ---&gt; Running in a78e73b6e1b9
Removing intermediate container a78e73b6e1b9
 ---&gt; 96dd2f890cbf
Successfully built 96dd2f890cbf
</code></pre></div><p>we can see that the step <code>2</code> was skipped and the cached version for that layer (that runs <code>RUN apt-get update -y && apt-get upgrade -y</code>) was used.
This is an important distinction to make if we build this image on the same machine (environment) where it was previously built the <code>RUN</code> command will not be executed.</p><p>This helps us maintain the same OS-lvl libraries and binaries when we build images but open a new problem: <strong>security</strong>.</p><p>One reason why you may want to update the libraries is to make sure you have the latest security patches.
The build command helpfully allows us to disable the cache with the <code>--no-cache</code> command. Running the build in this way we can see that the updates are running.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build . --no-cache
Sending build context to Docker daemon  3.072kB
Step 1/5 : FROM python:2.7-slim
 ---&gt; b0259cf63993
Step 2/5 : RUN apt-get update -y <span style=color:#f92672>&amp;&amp;</span> apt-get upgrade -y
 ---&gt; Running in cce3fb472a18
Get:1 http://security.debian.org jessie/updates InRelease <span style=color:#f92672>[</span>63.1 kB<span style=color:#f92672>]</span>
Get:2 http://security.debian.org jessie/updates/main amd64 Packages <span style=color:#f92672>[</span><span style=color:#ae81ff>588</span> kB<span style=color:#f92672>]</span>
...
...
 ---&gt; 1dc0f9d842b1
Step 3/5 : ADD . /app
 ---&gt; 597a83647250
Step 4/5 : EXPOSE <span style=color:#ae81ff>80</span>
 ---&gt; Running in 4e0da110e6f4
Removing intermediate container 4e0da110e6f4
 ---&gt; 8159270ed233
Step 5/5 : CMD <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span><span style=color:#f92672>]</span>
 ---&gt; Running in 8c3928f25d7a
Removing intermediate container 8c3928f25d7a
 ---&gt; 4eb0161a51ab
Successfully built 4eb0161a51ab
</code></pre></div><p>Another problem with updating images is the amount of unnecessary updated it will bring, a docker image should be light and only contain the <strong>required</strong> dependencies.
Thankfully most containers don&rsquo;t and <strong>shouldn&rsquo;t</strong> be exposed to the internet. This minimizes the attack vectors a bad actor can use.</p><h3 id=caching>Caching</h3><p>Another problem with <code>apt-get</code> in a container is the caching problem. You can&rsquo;t have a docker file that looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>RUN apt-get update -y
RUN apt-get upgrade -y
</code></pre></div><p>The first command will use a cache that is not shared with the second command; this is a good reason why you should chain them using bash <code>&&</code>.</p><div class=related></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p></p></div></section><script>(function(a,c,e,f,d,b){a.hj=a.hj||function(){(a.hj.q=a.hj.q||[]).push(arguments)},a._hjSettings={hjid:'2229847',hjsv:6},d=c.getElementsByTagName('head')[0],b=c.createElement('script'),b.async=1,b.src=e+a._hjSettings.hjid+f+a._hjSettings.hjsv,d.appendChild(b)})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=')</script><script type=text/javascript>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","5rbe8xe2a1")</script></body></html>